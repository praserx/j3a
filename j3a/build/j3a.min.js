(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.J3A=f()}})(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){"use strict";function Acl(){}Acl.prototype.resources=new Array;Acl.prototype.LoadAcl=function(acl){for(var i=0;i<acl.length;i++){var resource=new Object;resource.resource_id=acl[i]["resource-id"];resource.resource_uri=acl[i]["resource-uri"];resource.access=acl[i]["access"];resource.permission=acl[i]["permission"];resource.secret=acl[i]["secret"];this.resources.push(resource)}};Acl.prototype.GetAclResourceSecretById=function(id){for(var i=0;i<this.resources.length;i++){if(this.resources[i].resource_id==id){return this.resources[i].secret}}return null};Acl.prototype.GetAclResourcePermissionById=function(id){for(var i=0;i<this.resources.length;i++){if(this.resources[i].resource_id==id){return this.resources[i].permission}}};module.exports=Acl},{}],2:[function(require,module,exports){"use strict";function Config(){}Config.prototype.siteName="Unknown";Config.prototype.uri=null;Config.prototype.allowCache="false";Config.prototype.autoLogout="true";Config.prototype.deniedInfoElement=null;Config.prototype.deniedInfoPage=null;Config.prototype.filePermGroups=null;Config.prototype.permGroups=null;Config.prototype.uriAcl=null;Config.prototype.uriBase=null;Config.prototype.uriResources=null;Config.prototype.uriRoles=null;Config.prototype.uriVersion=null;Config.prototype.uriUsers=null;Config.prototype.algorithmPublicKeyEncryption=null;Config.prototype.algorithmPrivateKeyEncryption=null;Config.prototype.algorithmDigest=null;Config.prototype.algorithmSign=null;Config.prototype.algorithmKeyDerivation=null;Config.prototype.LoadConfig=function(config){if("site-name"in config){this.siteName=config["site-name"]}else{throw new Error("Config: Missing 'site-name'.")}if("allow-cache"in config){this.allowCache=config["allow-cache"]}if("auto-logout"in config){this.autoLogout=config["auto-logout"]}if("denied-info-element"in config){this.deniedInfoElement=config["denied-info-element"]}else{throw new Error("Config: Missing 'denied-info-element'.")}if("denied-info-page"in config){this.deniedInfoPage=config["denied-info-page"]}else{throw new Error("Config: Missing 'denied-info-page'.")}if("file-perm-groups"in config){this.filePermGroups=config["file-perm-groups"]}if("perm-groups"in config){this.permGroups=config["perm-groups"]}if("uri-base"in config){this.uriBase=config["uri-base"]}else{throw new Error("Config: Missing 'uri-base'.")}if("uri-acl"in config){this.uriAcl=config["uri-acl"]}else{throw new Error("Config: Missing 'uri-acl'.")}if("uri-resources-dir"in config){this.uriResources=config["uri-resources-dir"]}else{throw new Error("Config: Missing 'uri-resources-dir'.")}if("uri-roles"in config){this.uriRoles=config["uri-roles"]}else{throw new Error("Config: Missing 'uri-roles'.")}if("uri-version"in config){this.uriVersion=config["uri-version"]}else{throw new Error("Config: Missing 'uri-version'.")}if("uri-users-dir"in config){this.uriUsers=config["uri-users-dir"]}else{throw new Error("Config: Missing 'uri-users-dir'.")}if("algorithms"in config){if("public-key-encryption"in config["algorithms"]){this.algorithmPublicKeyEncryption=config["algorithms"]["public-key-encryption"]}else{throw new Error("Config: Missing 'public-key-encryption' in 'algorithms'.")}if("private-key-encryption"in config["algorithms"]){this.algorithmPrivateKeyEncryption=config["algorithms"]["private-key-encryption"]}else{throw new Error("Config: Missing 'private-key-encryption' in 'algorithms'.")}if("digest"in config["algorithms"]){this.algorithmDigest=config["algorithms"]["digest"]}else{throw new Error("Config: Missing 'digest' in 'algorithms'.")}if("sign"in config["algorithms"]){this.algorithmSign=config["algorithms"]["sign"]}else{throw new Error("Config: Missing 'sign' in 'algorithms'.")}if("public-key-encryption"in config["algorithms"]){this.algorithmKeyDerivation=config["algorithms"]["key-derivation"]}else{throw new Error("Config: Missing 'key-derivation' in 'algorithms'.")}}else{throw new Error("Config: Missing 'algorithms'.")}};Config.prototype.GetUriBase=function(){var slash=this.uriBase.substr(this.uriBase.length-1);if(slash=="/"){return this.uriBase}else if(slash=="\\"){return this.uriBase}else{return this.uriBase+"/"}};Config.prototype.GetUriAcl=function(){return this.GetUriBase()+this.uriAcl};Config.prototype.GetUriRoles=function(){return this.GetUriBase()+this.uriRoles};Config.prototype.GetUriVersion=function(){return this.GetUriBase()+this.uriVersion};Config.prototype.GetUriUsers=function(){var slash=this.uriUsers.substr(this.uriUsers.length-1);if(slash=="/"){return this.uriUsers}else if(slash=="\\"){return this.uriUsers}else{return this.uriUsers+"/"}};Config.prototype.GetUriResources=function(){var slash=this.uriResources.substr(this.uriResources.length-1);if(slash=="/"){return this.uriResources}else if(slash=="\\"){return this.uriResources}else{return this.uriResources+"/"}};Config.prototype.GetUriDeniedInfoPage=function(){return this.GetUriBase()+this.deniedInfoPage};Config.prototype.GetUriDeniedInfoElement=function(){return this.GetUriBase()+this.deniedInfoElement};Config.prototype.GetUriUserByUsername=function(username){return this.GetUriBase()+this.GetUriUsers()+username+".json"};Config.prototype.GetUriResourceById=function(resourceId){return this.GetUriBase()+this.GetUriResources()+resourceId+".json"};module.exports=Config},{}],3:[function(require,module,exports){"use strict";var Crypter=require("./crypter.js");var Worker=require("./worker.js");var Seed=require("./seed.js");var Acl=require("./acl.js");var Config=require("./config.js");var Roles=require("./roles.js");function Core(){if(!window.jQuery){throw new Error("J3A: jQuery library is required! Import jQuery first! Newest verstion recommended.")}}Core.prototype.acl=null;Core.prototype.config=null;Core.prototype.version=null;Core.prototype.crypter=null;Core.prototype.roles=null;Core.prototype.seed=null;Core.prototype.worker=null;Core.prototype.devMode=false;Core.prototype.prefix=null;Core.prototype.Init=function(uriConfig){var newVersion=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;var prefix=arguments.length>2&&arguments[2]!==undefined?arguments[2]:"";var self=this;this.prefix=prefix+"_";return new Promise(function(resolve,reject){if(self.devMode){console.log("[CORE] Starting initialization")}var config=window.localStorage.getItem(self.prefix+"config");var acl=window.localStorage.getItem(self.prefix+"acl");var roles=window.localStorage.getItem(self.prefix+"roles");var version=window.localStorage.getItem(self.prefix+"version");self.crypter=new Crypter;self.worker=new Worker;self.seed=new Seed(self.prefix);jQuery.ajaxSetup({cache:false});if(config==null||acl==null||roles==null||self.devMode==true||newVersion==true){if(self.devMode){console.log("[CORE] Downloading config.json, acl.json and roles.json from site")}var jqxhrConfig=jQuery.getJSON(uriConfig,function(response){config=response;self.config=new Config;self.config.LoadConfig(response)}).fail(function(error){if(self.devMode){console.log("[CORE] Can't donwload 'config.json' file.")}reject(error)});jqxhrConfig.done(function(){var jqxhrVersion=jQuery.getJSON(self.config.GetUriVersion(),function(response){version=response;self.version=version["page-version"]}).fail(function(error){if(self.devMode){console.log("[CORE] Can't donwload 'version.json' file.")}reject(error)});var jqxhrAcl=jQuery.getJSON(self.config.GetUriAcl(),function(response){acl=response;self.acl=new Acl;self.acl.LoadAcl(response)}).fail(function(error){if(self.devMode){console.log("[CORE] Can't donwload 'acl.json' file.")}reject(error)});var jqxhrRoles=jQuery.getJSON(self.config.GetUriRoles(),function(response){roles=response;self.roles=new Roles;self.roles.LoadRoles(response)}).fail(function(error){if(self.devMode){console.log("[CORE] Can't donwload 'roles.json' file.")}reject(error)});jQuery.when(jqxhrAcl,jqxhrRoles,jqxhrVersion).done(function(){if(self.config.allowCache=="true"){window.localStorage.setItem(self.prefix+"version",self.version);window.localStorage.setItem(self.prefix+"config",JSON.stringify(config));window.localStorage.setItem(self.prefix+"acl",JSON.stringify(acl));window.localStorage.setItem(self.prefix+"roles",JSON.stringify(roles))}resolve("complete")})})}else{var newPageVersion=null;if(self.devMode){console.log("[CORE] Loading config, acl and roles from cache")}self.config=new Config;self.config.LoadConfig(JSON.parse(config));self.acl=new Acl;self.acl.LoadAcl(JSON.parse(acl));self.roles=new Roles;self.roles.LoadRoles(JSON.parse(roles));var jqxhrVersion=jQuery.getJSON(self.config.GetUriVersion(),function(response){newPageVersion=response["page-version"]}).fail(function(error){if(self.devMode){console.log("[CORE] Can't donwload 'version.json' file.")}reject(error)});jQuery.when(jqxhrVersion).done(function(){if(newPageVersion!=version){self.Init(uriConfig,true,self.prefix).then(function(){resolve("complete")})}else{resolve("complete")}})}})};Core.prototype.RunPostProcessing=function(){var self=this;return new Promise(function(resolve,reject){if(self.worker.LoadElements()==0){resolve("success")}var evaluateElements=function evaluateElements(elements,index){return new Promise(function(resolve,reject){if(self.IsAuthorized(elements[index].resourceId,self.GetUser())){self.seed.GetElementById(elements[index].resourceId).then(function(element){self.worker.ReplaceElement(elements[index].resourceId,element);if(index+1<elements.length){evaluateElements(elements,index+1);resolve("success")}else{resolve("success")}resolve("success")}).catch(function(error){reject(error)})}else{var oda=elements[index].oda;if(oda=="R"){window.location.href=self.config.GetUriDeniedInfoPage()}else if(oda=="W"){self.worker.ReplaceByWarningElement(elements[index].resourceId,self.config.GetUriDeniedInfoElement())}else if(oda=="H"){}else{if(self.devMode){console.log("[CORE] Warning! Unknown ODA!")}window.location.href=self.config.GetUriDeniedInfoPage()}if(index+1<elements.length){evaluateElements(elements,index+1);resolve("denied")}else{resolve("denied")}}})};evaluateElements(self.worker.GetElements(),0).then(function(){resolve()}).catch(function(error){reject(error)})})};Core.prototype.EnableDevMode=function(){this.devMode=true};Core.prototype.Login=function(username,password,sli){var self=this;return new Promise(function(resolve,reject){if(self.config==null){if(self.devMode){console.log("[CORE] Config is null, something is wrong.")}reject("failure")}self.PartialLogout();username=typeof username!=="undefined"?username:null;password=typeof password!=="undefined"?password:null;sli=typeof sli!=="undefined"?sli:false;if(username==null||password==null){if(self.devMode){console.log("[CORE] Username or password is wrong...")}reject("failure")}var uriUser=self.config.GetUriUserByUsername(username);var jqxhrUser=jQuery.getJSON(uriUser,function(response){var ciphername=response["secret-algorithm"]["name"];var algorithm={};var secret=response["secret"];var roles=response["roles"];if(ciphername=="AES-GCM"){algorithm={name:response["secret-algorithm"]["name"],iv:response["secret-algorithm"]["iv"],tag:response["secret-algorithm"]["tag"]}}else{if(self.devMode){console.log("[CORE] Algorithm "+ciphername+"is not supported.")}reject("failure")}if(response["key-type"]=="password"){self.crypter.Sha256Key(password,ciphername).then(function(key){self.crypter.Decrypt(algorithm,key,secret).then(function(plaintext){var rolesSecrets=JSON.parse(plaintext);self.GetResources(rolesSecrets).then(function(resources){self.crypter.Sha256(username+(new Date).toDateString()).then(function(result){var logoutToken=self.crypter.ArrayBufferToHexString(result);self.SaveCredentials(username,roles,logoutToken);resolve("success")})}).catch(function(error){if(self.devMode){console.log("[CORE] Exception: ");console.log(error)}reject("failure")})}).catch(function(error){if(self.devMode){console.log("[CORE] Exception: ");console.log(error)}reject("failure")})}).catch(function(error){if(self.devMode){console.log("[CORE] Exception: ");console.log(error)}reject("failure")})}else{if(self.devMode){console.log("[CORE] Exception: Key is asymetric-key type");console.log(error)}reject("failure")}}).fail(function(error){if(self.devMode){console.log("[CORE] jQuery error:");console.log(error)}reject("failure")})})};Core.prototype.LoginByPrivateKey=function(username,certificate,sli){var self=this;return new Promise(function(resolve,reject){if(self.config==null){if(self.devMode){console.log("[CORE] Config is null, something is wrong.")}reject("failure")}self.PartialLogout();username=typeof username!=="undefined"?username:null;certificate=typeof certificate!=="undefined"?certificate:null;sli=typeof sli!=="undefined"?sli:false;if(username==null||certificate==null){if(self.devMode){console.log("[CORE] Username or password is wrong...")}reject("failure")}var uriUser=self.config.GetUriUserByUsername(username);var jqxhrUser=jQuery.getJSON(uriUser,function(response){if(response["key-type"]=="certificate"){var ciphername=response["secret-algorithm"]["name"];var algorithm={};var secret=response["secret"];var roles=response["roles"];var keySecret=response["key-secret"];var keyAlgorithm=response["key-algorithm"]["name"];if(ciphername=="AES-GCM"){algorithm={name:response["secret-algorithm"]["name"],iv:response["secret-algorithm"]["iv"],tag:response["secret-algorithm"]["tag"]}}else{if(self.devMode){console.log("[CORE] Algorithm "+ciphername+"is not supported.")}reject("failure")}self.crypter.Pkcs8Key(certificate,keyAlgorithm).then(function(key){var publicKeyAlgorithm={name:keyAlgorithm};self.crypter.Decrypt(publicKeyAlgorithm,key,keySecret).then(function(secretKey){self.crypter.RawKey(secretKey,ciphername).then(function(key){self.crypter.Decrypt(algorithm,key,secret).then(function(plaintext){var rolesSecrets=JSON.parse(plaintext);self.GetResources(rolesSecrets).then(function(resources){self.crypter.Sha256(username+(new Date).toDateString()).then(function(result){var logoutToken=self.crypter.ArrayBufferToHexString(result);self.SaveCredentials(username,roles,logoutToken);resolve("success")})}).catch(function(error){if(self.devMode){console.log("[CORE] Exception: ");console.log(error)}reject("failure")})}).catch(function(error){if(self.devMode){console.log("[CORE] Exception: ");console.log(error)}reject("failure")})}).catch(function(error){if(self.devMode){console.log("[CORE] Exception: ");console.log(error)}reject("failure")})}).catch(function(error){if(self.devMode){console.log("[CORE] Exception: ");console.log(error)}reject("failure")})}).catch(function(error){if(self.devMode){console.log("[CORE] Exception: ");console.log(error)}reject("failure")})}else{if(self.devMode){console.log("[CORE] Exception: Key is symetric-key type");console.log(error)}reject("failure")}}).fail(function(error){if(self.devMode){console.log("[CORE] jQuery error:");console.log(error)}reject("failure")})})};Core.prototype.Logout=function(){var self=this;this.ClearCredentials();Seed.ClearDatabase()};Core.prototype.PartialLogout=function(){var self=this;this.ClearCredentials();this.seed.ClearRecords()};Core.prototype.AutoLogout=function(){var self=this;if(this.config.autoLogout=="true"){var name="logoutToken=";var cookieFound=false;var decodedCookie=decodeURIComponent(document.cookie);var ca=decodedCookie.split(";");for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)==" "){c=c.substring(1)}if(c.indexOf("logoutToken=")==0){if(c.substring("logoutToken=".length,c.length)!=window.localStorage.getItem(self.prefix+"user_logoutToken")){this.PartialLogout()}else{cookieFound=true}}}if(cookieFound!=true){this.PartialLogout()}}};Core.prototype.GetUser=function(){var self=this;var username=window.localStorage.getItem(this.prefix+"user_username");var roles=JSON.parse(window.localStorage.getItem(this.prefix+"user_roles"));if(username==null){return null}else{return{username:username,roles:roles}}};Core.Logged=function(){var prefix=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";var username=window.localStorage.getItem(prefix+"_"+"user_username");if(username==null){return false}else{return true}};Core.InRole=function(){var prefix=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";var roleName=arguments[1];var roles=window.localStorage.getItem(prefix+"_"+"user_roles");if(roles==null){return false}roles=JSON.parse(roles);for(var i=0;i<roles.length;i++){if(roles[i]==roleName){return true}}return false};Core.prototype.IsAuthorized=function(resourceId,user){var self=this;var resourcePermission=this.acl.GetAclResourcePermissionById(resourceId);if(user==null){return false}var getCompleteInheritance=function getCompleteInheritance(roleName,ilist){var newInher=false;var role=self.roles.GetRoleByName(roleName);for(var i=0;i<role.inherits.length;i++){if(!(role.inherits[i]in ilist)){newInher=true;ilist.push(role.inherits[i])}if(newInher==true){newInher=false;ilist=getCompleteInheritance(role.inherits[i],ilist)}}if(!(roleName in ilist)){ilist.push(roleName)}return ilist};var completeInheritance=[];for(var i=0;i<user.roles.length;i++){completeInheritance=completeInheritance.concat(getCompleteInheritance(user.roles[i],[]))}for(var i=0;i<resourcePermission.length;i++){for(var j=0;j<completeInheritance.length;j++){if(resourcePermission[i]==completeInheritance[j]){return true}}}return false};Core.prototype.GetBaseUrl=function(){var self=this;return this.config.GetUriBase()};Core.prototype.SaveCredentials=function(username,roles,logoutToken){var self=this;window.localStorage.setItem(self.prefix+"user_username",username);window.localStorage.setItem(self.prefix+"user_roles",JSON.stringify(roles));window.localStorage.setItem(self.prefix+"user_logoutToken",logoutToken);if(self.config.autoLogout=="true"){document.cookie=self.prefix+"logoutToken="+logoutToken}};Core.prototype.ClearCredentials=function(){var self=this;window.localStorage.removeItem(self.prefix+"user_username");window.localStorage.removeItem(self.prefix+"user_roles");window.localStorage.removeItem(self.prefix+"user_logoutToken");document.cookie=self.prefix+"logoutToken="};Core.prototype.GetResources=function(rolesCryptoKeys){var self=this;return new Promise(function(resolve,reject){self.DecryptRoles(rolesCryptoKeys,0).then(function(aclCryptoKeys){self.DecryptAclResources(aclCryptoKeys,0).then(function(resourcesCryptoKeys){var dlResourcesCryptoKeys=self.RemoveDuplicateResources(resourcesCryptoKeys);var dlResourcesIds=self.ExtractIds(dlResourcesCryptoKeys);self.DownloadResources(dlResourcesIds).then(function(encryptedResources){self.DecryptResources(dlResourcesCryptoKeys,encryptedResources).then(function(decryptedElements){self.seed.Insert(decryptedElements);resolve("success")}).catch(function(error){reject(error)})}).catch(function(error){reject(error)})}).catch(function(error){reject(error)})}).catch(function(error){reject(error)})})};Core.prototype.DecryptRoles=function(rolesCryptoKeys){var index=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var self=this;return new Promise(function(resolve,reject){var secret=self.roles.GetRoleSecretByName(rolesCryptoKeys[index].role);var role=rolesCryptoKeys[index].role;var algorithm=rolesCryptoKeys[index].secret.algorithm;var rawKey=rolesCryptoKeys[index].secret.key;self.crypter.RawKey(rawKey,algorithm.name).then(function(key){self.crypter.Decrypt(algorithm,key,secret).then(function(result){if(index+1!=rolesCryptoKeys.length){self.DecryptRoles(rolesCryptoKeys,index+1).then(function(prevResults){prevResults.push(JSON.parse(result));resolve(prevResults)})}else{resolve(JSON.parse(result))}}).catch(function(error){console.log("[CORE] Roles decryption error:");console.log(error);reject("failure")})}).catch(function(error){console.log("[CORE] roles key import error:");console.log(error);reject("failure")})})};Core.prototype.DecryptAclResources=function(aclCryptoKeys){var index=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var self=this;return new Promise(function(resolve,reject){var secret=self.acl.GetAclResourceSecretById(aclCryptoKeys[index].resource_id);var resource_id=aclCryptoKeys[index].resource_id;var algorithm=aclCryptoKeys[index].secret.algorithm;var rawKey=aclCryptoKeys[index].secret.key;self.crypter.RawKey(rawKey,algorithm.name).then(function(key){self.crypter.Decrypt(algorithm,key,secret).then(function(result){var convResult=JSON.parse(result);convResult.resource_id=resource_id;if(index+1!=aclCryptoKeys.length){self.DecryptAclResources(aclCryptoKeys,index+1).then(function(prevResults){prevResults.push(convResult);resolve(prevResults)})}else{resolve([convResult])}}).catch(function(error){if(self.devMode){console.log("[CORE] ACL resource decryption error:");console.log(error)}reject("failure")})}).catch(function(error){if(self.devMode){console.log("[CORE] ACL resources key import error:");console.log(error)}reject("failure")})})};Core.prototype.DecryptResources=function(resourcesCryptoKeys,encryptedResources){var index=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var self=this;return new Promise(function(resolve,reject){var secret=self.GetEncryptedResourceById(encryptedResources,resourcesCryptoKeys[index].resource_id);var resource_id=resourcesCryptoKeys[index].resource_id;var algorithm=resourcesCryptoKeys[index].algorithm;var rawKey=resourcesCryptoKeys[index].key;self.crypter.RawKey(rawKey,algorithm.name).then(function(key){self.crypter.Decrypt(algorithm,key,secret).then(function(result){var encryptedElement=Object();encryptedElement.resource_id=resource_id;encryptedElement.content=result;if(index+1!=resourcesCryptoKeys.length){self.DecryptResources(resourcesCryptoKeys,encryptedResources,index+1).then(function(prevResults){prevResults.push(encryptedElement);resolve(prevResults)})}else{resolve([encryptedElement])}}).catch(function(error){if(self.devMode){console.log("[CORE] Resource decryption error:");console.log(error)}reject("failure")})}).catch(function(error){if(self.devMode){console.log("[CORE] Resource key import error:");console.log(error)}reject("failure")})})};Core.prototype.DownloadResources=function(resourcesIds){var index=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var self=this;return new Promise(function(resolve,reject){var resourceUri=self.config.GetUriResourceById(resourcesIds[index]);jQuery.getJSON(resourceUri,function(resource){if(index+1!=resourcesIds.length){self.DownloadResources(resourcesIds,index+1).then(function(prevResources){resource.resource_id=resourcesIds[index];prevResources.push(resource);resolve(prevResources)})}else{resource.resource_id=resourcesIds[index];resolve([resource])}}).fail(function(error){reject(error)})})};Core.prototype.ExtractIds=function(structuredArray){var self=this;var ids=[];for(var i=0;i<structuredArray.length;i++){ids.push(structuredArray[i].resource_id)}return ids};Core.prototype.RemoveDuplicateResources=function(resources){var self=this;var dlResources=[];for(var i=0;i<resources.length;i++){var occ=false;for(var j=0;j<dlResources.length;j++){if(resources[i].resource_id==dlResources[j].resource_id){occ=true}}if(occ==false){dlResources.push(resources[i])}}return dlResources};Core.prototype.GetEncryptedResourceById=function(resources,id){var self=this;for(var i=0;i<resources.length;i++){if(resources[i].resource_id==id){return resources[i].ciphertext}}return null};module.exports=Core},{"./acl.js":1,"./config.js":2,"./crypter.js":4,"./roles.js":5,"./seed.js":6,"./worker.js":7}],4:[function(require,module,exports){"use strict";function Crypter(){this.crypto=window.crypto||window.msCrypto;if(this.crypto==null){throw new Error("Crypto API is not supported in this browser")}this.subtle=this.crypto.subtle;if(this.subtle==null){throw new Error("Crypto API is not supported in this browser")}}Crypter.prototype.crypto=null;Crypter.prototype.subtle=null;Crypter.prototype.Decrypt=function(algorithm,key,secret){var self=this;var ciphername=algorithm.name;return new Promise(function(resolve,reject){if(ciphername=="AES-GCM"){self.DecrypAesGcm(algorithm.iv,algorithm.tag,secret,key).then(function(plaintext){resolve(plaintext)}).catch(function(error){reject(error)})}else if(ciphername=="RSA-OAEP"){self.DecrypRsaOaep(secret,key).then(function(plaintext){resolve(plaintext)}).catch(function(error){reject(error)})}else{reject("[CRYPTER] Algorithm "+ciphername+"is not supported.")}})};Crypter.prototype.DeriveKey=function(algortithm,password){var self=this;return new Promise(function(resolve,reject){resolve()})};Crypter.prototype.Hash=function(algortithm,plaintext){var self=this;return new Promise(function(resolve,reject){resolve()})};Crypter.prototype.DecrypAesGcm=function(iv,tag,secret,key){var self=this;var ivBuffered=self.HexStrToByteArray(iv);var secretBufferd=self.HexStrToByteArray(secret);var alg={name:"AES-GCM",iv:ivBuffered,tagLength:tag};return new Promise(function(resolve,reject){self.subtle.decrypt(alg,key,secretBufferd).then(function(plainBuffer){try{resolve((new TextDecoder).decode(plainBuffer))}catch(error){resolve(self.ArrayBufferToString(plainBuffer))}}).catch(function(error){console.log("[CRYPTER] Exception: ");console.log(error);reject(error)})})};Crypter.prototype.DecrypRsaOaep=function(secret,key){var self=this;var alg={name:"RSA-OAEP"};var secretBufferd=self.HexStrToByteArray(secret);return new Promise(function(resolve,reject){self.subtle.decrypt(alg,key,secretBufferd).then(function(plainBuffer){try{resolve((new TextDecoder).decode(plainBuffer))}catch(error){resolve(self.ArrayBufferToString(plainBuffer))}}).catch(function(error){console.log("[CRYPTER] Exception: ");console.log(error);reject(error)})})};Crypter.prototype.Sha256=function(plaintext){var self=this;return new Promise(function(resolve,reject){var plaintextUtf8=null;try{plaintextUtf8=(new TextEncoder).encode(password)}catch(error){plaintextUtf8=self.StrToByteArray(password)}self.subtle.digest("SHA-256",plaintextUtf8).then(function(hash){resolve(hash)}).catch(function(error){reject(error)})})};Crypter.prototype.Sha512=function(plaintext){var self=this;return new Promise(function(resolve,reject){var plaintextUtf8=null;try{plaintextUtf8=(new TextEncoder).encode(password)}catch(error){plaintextUtf8=self.StrToByteArray(password)}self.subtle.digest("SHA-512",plaintextUtf8).then(function(hash){resolve(hash)}).catch(function(error){reject(error)})})};Crypter.prototype.Pbkdf2Key=function(password,salt,cipher){var self=this;return new Promise(function(resolve,reject){self.subtle.importKey("raw",self.StrToByteArray(password),{name:"PBKDF2"},false,["deriveKey","deriveBits"]).then(function(key){self.subtle.deriveKey({name:"PBKDF2",salt:self.HexStrToByteArray(salt),iterations:1e3,hash:"SHA-256"},key,{name:cipher,length:256},false,["encrypt","decrypt"]).then(function(key){resolve(key)}).catch(function(err){reject(err)})}).catch(function(err){console.error(err)})})};Crypter.prototype.Sha256Key=function(password,ciphername){var self=this;var pwdUtf8="";try{pwdUtf8=(new TextEncoder).encode(password)}catch(error){pwdUtf8=self.StrToByteArray(password)}var alg={name:ciphername};return new Promise(function(resolve,reject){self.subtle.digest("SHA-256",pwdUtf8).then(function(pwdHash){self.subtle.importKey("raw",pwdHash,alg,false,["encrypt","decrypt"]).then(function(key){resolve(key)}).catch(function(error){reject(error)})}).catch(function(error){reject(error)})})};Crypter.prototype.RawKey=function(rawKey,ciphername){var self=this;var alg={name:ciphername};return new Promise(function(resolve,reject){self.subtle.importKey("raw",self.HexStrToByteArray(rawKey),alg,false,["encrypt","decrypt"]).then(function(key){resolve(key)}).catch(function(error){reject(error)})})};Crypter.prototype.Pkcs8Key=function(pemPrivateKey,ciphername){var self=this;return new Promise(function(resolve,reject){self.subtle.importKey("pkcs8",self.PemToByteArray(pemPrivateKey),{name:ciphername,hash:{name:"SHA-256"}},true,["decrypt"]).then(function(key){resolve(key)}).catch(function(error){reject(error)})})};Crypter.prototype.ArrayBufferToHexString=function(buffer){var hexCodes=[];var view=new DataView(buffer);for(var i=0;i<view.byteLength;i+=4){var value=view.getUint32(i);var stringValue=value.toString(16);var padding="00000000";var paddedValue=(padding+stringValue).slice(-padding.length);hexCodes.push(paddedValue)}return hexCodes.join("").toLocaleUpperCase()};Crypter.prototype.ArrayBufferToString=function(buffer){return String.fromCharCode.apply(null,buffer)};Crypter.prototype.HexStrToByteArray=function(hex){var bufferLength=Math.floor(hex.length/2);var byteArray=new Uint8Array(bufferLength);if(Math.floor(hex.length%2)==0){for(var i=0,y=0;i<hex.length;i+=2,y++){var strHexTuple=hex.substr(i,2);byteArray[y]=parseInt(strHexTuple,16)}}else{throw new Error("Hexadecimal string length error!")}return byteArray};Crypter.prototype.StrToByteArray=function(str){var bufferLength=Math.floor(str.length);var byteArray=new Uint8Array(bufferLength);for(var i=0;i<str.length;i++){byteArray[i]=str.charCodeAt(i)}return byteArray};Crypter.prototype.Base64ToByteArray=function(base64String){var byteString=window.atob(base64String);var byteArray=new Uint8Array(byteString.length);for(var i=0;i<byteString.length;i++){byteArray[i]=byteString.charCodeAt(i)}return byteArray};Crypter.prototype.PemToByteArray=function(pem){var b64Lines=pem.replace(/\r?\n|\r/g,"");var b64Prefix=b64Lines.replace("-----BEGIN PRIVATE KEY-----","");var b64Final=b64Prefix.replace("-----END PRIVATE KEY-----","");return this.Base64ToByteArray(b64Final)};module.exports=Crypter},{}],5:[function(require,module,exports){"use strict";function Roles(){}Roles.prototype.roles=new Array;Roles.prototype.LoadRoles=function(roles){for(var i=0;i<roles.length;i++){var role=new Object;role.name=roles[i]["role"];role.inherits=roles[i]["inherits"];role.secret=roles[i]["secret"];this.roles.push(role)}};Roles.prototype.GetRoleByName=function(roleName){for(var i=0;i<this.roles.length;i++){if(this.roles[i].name==roleName){return this.roles[i]}}return null};Roles.prototype.GetRoleSecretByName=function(role){for(var i=0;i<this.roles.length;i++){if(this.roles[i].name==role){return this.roles[i].secret}}return null};Roles.prototype.GetRoleNames=function(){var roleNames=[];for(var role in this.roles){roleNames.push(role.name)}return roleNames};module.exports=Roles},{}],6:[function(require,module,exports){"use strict";function Seed(prefix){this.prefix=prefix}Seed.prototype.records=[];Seed.prototype.prefix=null;Seed.prototype.Insert=function(records){for(var i=0;i<records.length;i++){this.records.push(this.prefix+"db_"+records[i].resource_id);window.localStorage.setItem(this.prefix+"db_"+records[i].resource_id,records[i].content)}};Seed.prototype.GetElementById=function(id){var self=this;return new Promise(function(resolve,reject){var search=self.prefix+"db_"+id;var item=window.localStorage.getItem(search);if(item!=null){resolve(item)}else{reject("Not found.")}})};Seed.prototype.ClearRecords=function(){for(var i=0;i<this.records.length;i++){window.localStorage.removeItem(this.records[i])}};Seed.ClearDatabase=function(){var self=this;return new Promise(function(resolve,reject){for(var i=0;i<self.records.length;i++){window.localStorage.removeItem(self.records[i])}resolve("success")})};module.exports=Seed},{}],
7:[function(require,module,exports){"use strict";function Worker(){}Worker.prototype.ees=null;Worker.prototype.LoadElements=function(){var ees=jQuery("encrypted-element");this.ees=[];for(var i=0;i<ees.length;i++){var ee=Object();ee.resourceId=ees[i].getAttribute("resource-id");ee.oda=ees[i].getAttribute("oda");this.ees.push(ee)}return ees.length};Worker.prototype.GetElements=function(){return this.ees};Worker.prototype.GetElementByResourceId=function(id){var ees=jQuery("encrypted-element");for(var i=0;i<ees.length;i++){if(id==ees[i].getAttribute("resource-id")){return ees[i]}}return null};Worker.prototype.ReplaceElement=function(id,content){var element=this.GetElementByResourceId(id);jQuery(element).replaceWith(content)};Worker.prototype.ReplaceByWarningElement=function(id,url){var element=this.GetElementByResourceId(id);jQuery(element).load(url)};module.exports=Worker},{}]},{},[3])(3)});